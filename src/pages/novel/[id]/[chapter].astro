---
import Layout from '../../../layouts/Layout.astro';
import { novels, getNovelById, getChapterById } from '../../../data/novels';

export function getStaticPaths() {
  const paths: { params: { id: string; chapter: string } }[] = [];
  
  novels.forEach(novel => {
    novel.chapters.forEach(chapter => {
      paths.push({
        params: { 
          id: novel.id,
          chapter: chapter.id
        },
      });
    });
  });
  
  return paths;
}

const { id, chapter: chapterId } = Astro.params;
const novel = getNovelById(id);

if (!novel) {
  return Astro.redirect('/404');
}

const chapter = getChapterById(id, chapterId);

if (!chapter) {
  return Astro.redirect('/404');
}

const currentIndex = novel.chapters.findIndex(c => c.id === chapterId);
const prevChapter = currentIndex > 0 ? novel.chapters[currentIndex - 1] : null;
const nextChapter = currentIndex < novel.chapters.length - 1 ? novel.chapters[currentIndex + 1] : null;
---

<Layout title={`${chapter.title} - ${novel.title}`}>
  <div class="reader-page">
    <!-- Reader Header -->
    <header class="reader-header">
      <div class="reader-header-content">
        <a href={`/novel/${novel.id}`} class="back-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          <span class="back-text">Back to Novel</span>
        </a>
        <div class="reader-title">
          <a href={`/novel/${novel.id}`} class="novel-link">{novel.title}</a>
          <span class="chapter-info">{chapter.title}</span>
        </div>
        <div class="reader-actions">
          <button class="action-btn" id="settings-btn" title="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
          <button class="action-btn" id="theme-toggle-btn" title="Toggle Theme">
            <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Reader Content -->
    <main class="reader-content" id="reader-content">
      <article class="chapter-article">
        <h1 class="chapter-title">{chapter.title}</h1>
        <div class="chapter-content" set:html={chapter.content} />
      </article>
    </main>

    <!-- Chapter Navigation -->
    <nav class="chapter-nav">
      <div class="nav-content">
        {prevChapter ? (
          <a href={`/novel/${novel.id}/${prevChapter.id}`} class="nav-btn prev">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            <span>Previous</span>
          </a>
        ) : (
          <span class="nav-btn disabled">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            <span>Previous</span>
          </span>
        )}

        <div class="chapter-selector">
          <select id="chapter-select" class="chapter-select">
            {novel.chapters.map(ch => (
              <option value={ch.id} selected={ch.id === chapterId}>
                Chapter {ch.number}: {ch.title}
              </option>
            ))}
          </select>
        </div>

        {nextChapter ? (
          <a href={`/novel/${novel.id}/${nextChapter.id}`} class="nav-btn next">
            <span>Next</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
        ) : (
          <span class="nav-btn disabled">
            <span>Next</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </span>
        )}
      </div>
    </nav>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-content">
        <div class="settings-header">
          <h3>Reader Settings</h3>
          <button class="close-btn" id="close-settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        
        <div class="settings-group">
          <label>Font Size</label>
          <div class="font-size-controls">
            <button class="font-btn" id="font-decrease">A-</button>
            <span id="font-size-display">18px</span>
            <button class="font-btn" id="font-increase">A+</button>
          </div>
        </div>

        <div class="settings-group">
          <label>Line Height</label>
          <div class="line-height-slider">
            <input type="range" min="1.4" max="2.2" step="0.1" value="1.8" id="line-height-slider" />
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Theme toggle
  document.getElementById('theme-toggle-btn')?.addEventListener('click', () => {
    window.toggleTheme();
  });

  // Settings panel
  const settingsBtn = document.getElementById('settings-btn');
  const settingsPanel = document.getElementById('settings-panel');
  const closeSettings = document.getElementById('close-settings');

  settingsBtn?.addEventListener('click', () => {
    settingsPanel?.classList.toggle('active');
  });

  closeSettings?.addEventListener('click', () => {
    settingsPanel?.classList.remove('active');
  });

  // Font size
  let fontSize = parseInt(localStorage.getItem('fontSize') || '18');
  const readerContent = document.getElementById('reader-content') as HTMLElement;
  const fontSizeDisplay = document.getElementById('font-size-display');

  function updateFontSize() {
    if (readerContent) {
      readerContent.style.fontSize = fontSize + 'px';
    }
    if (fontSizeDisplay) {
      fontSizeDisplay.textContent = fontSize + 'px';
    }
    localStorage.setItem('fontSize', fontSize.toString());
  }

  updateFontSize();

  document.getElementById('font-decrease')?.addEventListener('click', () => {
    if (fontSize > 14) {
      fontSize -= 2;
      updateFontSize();
    }
  });

  document.getElementById('font-increase')?.addEventListener('click', () => {
    if (fontSize < 28) {
      fontSize += 2;
      updateFontSize();
    }
  });

  // Line height
  const lineHeightSlider = document.getElementById('line-height-slider') as HTMLInputElement;
  
  if (lineHeightSlider) {
    lineHeightSlider.value = localStorage.getItem('lineHeight') || '1.8';
    
    lineHeightSlider.addEventListener('input', () => {
      if (readerContent) {
        readerContent.style.lineHeight = lineHeightSlider.value;
      }
      localStorage.setItem('lineHeight', lineHeightSlider.value);
    });

    if (readerContent) {
      readerContent.style.lineHeight = lineHeightSlider.value;
    }
  }

  // Chapter selector
  const chapterSelect = document.getElementById('chapter-select') as HTMLSelectElement;
  
  chapterSelect?.addEventListener('change', () => {
    const novelId = window.location.pathname.split('/')[2];
    window.location.href = `/novel/${novelId}/${chapterSelect.value}`;
  });
</script>

<style>
  .reader-page {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: var(--reader-bg);
    color: var(--reader-text);
  }

  .reader-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--header-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 0.75rem 1rem;
  }

  .reader-header-content {
    max-width: 1000px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .back-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    transition: color 0.2s ease;
    flex-shrink: 0;
  }

  .back-btn:hover {
    color: var(--accent-primary);
  }

  .back-text {
    display: none;
  }

  @media (min-width: 768px) {
    .back-text {
      display: inline;
    }
  }

  .reader-title {
    flex: 1;
    text-align: center;
    min-width: 0;
  }

  .novel-link {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .novel-link:hover {
    color: var(--accent-primary);
  }

  .chapter-info {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .reader-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 0.5rem;
    background-color: var(--bg-secondary);
    color: var(--text-primary);
    transition: all 0.2s ease;
  }

  .action-btn:hover {
    background-color: var(--bg-tertiary);
  }

  .moon-icon {
    display: none;
  }

  [data-theme="dark"] .sun-icon {
    display: none;
  }

  [data-theme="dark"] .moon-icon {
    display: block;
  }

  .reader-content {
    flex: 1;
    max-width: var(--reader-max-width);
    margin: 0 auto;
    padding: 2rem 1rem;
    font-size: 18px;
    line-height: 1.8;
  }

  @media (min-width: 768px) {
    .reader-content {
      padding: 3rem 2rem;
    }
  }

  .chapter-article {
    animation: fadeIn 0.3s ease;
  }

  .chapter-article .chapter-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
  }

  .chapter-content {
    text-align: justify;
  }

  .chapter-content p {
    margin-bottom: 1.5rem;
    text-indent: 1.5em;
  }

  .chapter-content p:first-of-type {
    text-indent: 0;
  }

  .chapter-content p:first-of-type::first-letter {
    font-size: 3em;
    float: left;
    line-height: 1;
    margin-right: 0.1em;
    font-weight: 700;
    color: var(--accent-primary);
  }

  .chapter-nav {
    position: sticky;
    bottom: 0;
    background-color: var(--header-bg);
    border-top: 1px solid var(--border-color);
    padding: 1rem;
    z-index: 100;
  }

  .nav-content {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background-color: var(--bg-secondary);
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    transition: all 0.2s ease;
  }

  .nav-btn:hover:not(.disabled) {
    background-color: var(--accent-primary);
    color: white;
  }

  .nav-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .chapter-selector {
    flex: 1;
    max-width: 200px;
  }

  .chapter-select {
    width: 100%;
    padding: 0.5rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    color: var(--text-primary);
    font-size: 0.75rem;
    cursor: pointer;
  }

  .chapter-select:focus {
    outline: none;
    border-color: var(--accent-primary);
  }

  .settings-panel {
    position: fixed;
    top: 0;
    right: -300px;
    width: 300px;
    height: 100%;
    background-color: var(--card-bg);
    border-left: 1px solid var(--border-color);
    box-shadow: var(--shadow-lg);
    transition: right 0.3s ease;
    z-index: 200;
  }

  .settings-panel.active {
    right: 0;
  }

  .settings-content {
    padding: 1.5rem;
  }

  .settings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .settings-header h3 {
    font-size: 1rem;
    font-weight: 600;
  }

  .close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 0.375rem;
    color: var(--text-secondary);
    transition: all 0.2s ease;
  }

  .close-btn:hover {
    background-color: var(--bg-secondary);
    color: var(--text-primary);
  }

  .settings-group {
    margin-bottom: 1.5rem;
  }

  .settings-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
  }

  .font-size-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .font-btn {
    flex: 1;
    padding: 0.5rem;
    background-color: var(--bg-secondary);
    border-radius: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
    transition: all 0.2s ease;
  }

  .font-btn:hover {
    background-color: var(--accent-primary);
    color: white;
  }

  #font-size-display {
    font-weight: 600;
    color: var(--text-primary);
  }

  .line-height-slider {
    padding: 0 0.5rem;
  }

  .line-height-slider input {
    width: 100%;
    accent-color: var(--accent-primary);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
